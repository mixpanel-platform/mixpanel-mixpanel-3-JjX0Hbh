<!doctype html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <style type="text/css">
      .eventSelect {
        margin-bottom: 15px;
        float: left;
      }
      
      .sessionSelectLabel {
        float: right;
        color: #747D94;
        font-size: 15px;
        font-weight: bold;
        margin-right: 11px;
        margin-top: 5px;
      }
      .sessionSelect {
        float: right;
      }
      
    </style>
  </head>
  <body class="mixpanel-platform-body">
    <div class="controls">
      
    <div class="eventSelect"></div>
    <div class="sessionSelect"></div>
    <div class="sessionSelectLabel">Session length:</div>
    </div>
    <div id="chart"></div>
    <script>
      var SESSION_ACTIVITY_LIMIT_SECONDS = 30; 
      var QUERY_INTERVAL_SECONDS = 3;
      var MAX_VALUES = 30
      
      var initializedAt = moment();
      var startTime = 0;
      var activeUsers = {};
      var pollInterval = null;
      var chart = new Highcharts.Chart({
          chart: {
              renderTo: 'chart',
              type: 'area'
          },
          title: {
            text: ''
          },
          xAxis: {
              type: 'category'
          },
           yAxis: {
              title: {
                  text: 'Active users'
              },
          },
          tooltip: {
              pointFormat: '{point.y:,.0f} active users'
          },
          series: [{name: 'Active users', data: []}]
      });
      
      var initialize = function() {
        clearInterval(pollInterval);
        chart.series[0].setData([]);
        chart.setTitle({text: ""});
        activeUsers = {};
        initializedAt = moment();
        startTime = 0;
        
        MP.api.query("/api/2.0/live").done(function(resp) { 
          var maxTs = 0;
          _.each(resp, function(event) {
            if (event.$ts > maxTs) maxTs = event.$ts;
          });
          startTime = maxTs - QUERY_INTERVAL_SECONDS;
        });
        
        getActiveUsers();
        pollInterval = setInterval(getActiveUsers, QUERY_INTERVAL_SECONDS * 1000);
      }
      
      var getActiveUsers = function() { 
        MP.api.query("/api/2.0/live", {start_time: startTime, search: $(".eventSelect").val() || ""}).done(function(resp) { 
        
          var usersInBatch = _.reduce(resp, function(results, event) {
            eventTimestamp = parseInt(event.$ts);
            startTime = Math.max(startTime, eventTimestamp)
            var distinctId = event.properties.distinct_id;
            if (distinctId && (!results[distinctId] || results[distinctId] < eventTimestamp)) {
              results[event.properties.distinct_id] = eventTimestamp;
            }
            return results
          }, {});
          
          activeUsers = _.extend(activeUsers, usersInBatch);
          _.each(activeUsers, function(lastActivity, distinctId) {
            if (lastActivity < startTime - SESSION_ACTIVITY_LIMIT_SECONDS * 1000) {
              console.log('deleting stale user session ' + distinctId + '. Last activity was ' + parseInt((startTime - lastActivity) / 1000) + ' seconds ago');
              delete activeUsers[distinctId];
            }
          });
          
          chart.series[0].addPoint({name: moment().format('HH:mm:ss'), y: _.keys(activeUsers).length}, true, chart.series[0].data.length > MAX_VALUES);
        });
        
        var eventLabel = "performing any event";
        if ($('.eventSelect').val()) {
          eventLabel = "performing \"" + $('.eventSelect').val() + "\"";
        }
        var secondsOnPage = parseInt(Math.max(1, (moment() - initializedAt) / 1000));
        chart.setTitle({text: _.sprintf("Users %s in the last %s seconds", eventLabel, SESSION_ACTIVITY_LIMIT_SECONDS)});
      }

      MP.api.ready(function() {
        $('.eventSelect').MPEventSelect().on('change', function() {
          initialize();
        });
        
        $('.sessionSelect').MPSelect({items: [[30, '30 seconds'], [60, '1 minute'], [300, '5 minutes'], [900, '15 minutes'], [1800, '30 minutes']]}).val(SESSION_ACTIVITY_LIMIT_SECONDS).on('change', function() {
          SESSION_ACTIVITY_LIMIT_SECONDS = $('.sessionSelect').val();
          initialize();
        });
        
        initialize();
      });
    </script>
  </body>
</html>
