<!doctype html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <div id="chart"></div>
    <script>
      var SESSION_ACTIVITY_LIMIT = 5; // minutes
      var startTime = 0;
      var activeUsers = {};
      var chart = new Highcharts.Chart({
          chart: {
              renderTo: 'chart',
              type: 'area'
          },
          title: {
              text: 'Active users'
          },
          subtitle: {
              text: 'Users currently using Mixpanel'
          },
          xAxis: {
              allowDecimals: false,
              labels: {
                  formatter: function () {
                      return this.value; // clean, unformatted number for year
                  }
              }
          },
           yAxis: {
              title: {
                  text: 'Active users'
              },
          },
          tooltip: {
              pointFormat: '{point.y:,.0f} active users'
          },
          plotOptions: {
              area: {
                  marker: {
                      enabled: false,
                      symbol: 'circle',
                      radius: 2,
                      states: {
                          hover: {
                              enabled: true
                          }
                      }
                  }
              }
          },
          series: [{name: 'Active users', data: []}]
      });
      
      var getActiveUsers = function() { 
        MP.api.query("/api/2.0/live", {start_time: startTime}).done(function(resp) { 
      
          var usersInBatch = _.reduce(resp, function(results, event) {
            eventTimestamp = parseInt(event.$ts);
            startTime = Math.max(startTime, eventTimestamp)
            var distinctId = event.properties.distinct_id;
            if (distinctId && (!results[distinctId] || results[distinctId] < eventTimestamp)) {
              results[event.properties.distinct_id] = eventTimestamp;
            }
            return results
          }, {});
          
          activeUsers = _.extend(activeUsers, usersInBatch);
          _.each(activeUsers, function(lastActivity, distinctId) {
            if (lastActivity < startTime - SESSION_ACTIVITY_LIMIT * 60 * 1000) {
              console.log('deleting stale user session ' + distinctId + '. Last activity was ' + parseInt((startTime - lastActivity) / 1000) + ' seconds ago');
              delete activeUsers[distinctId];
            }
          });
          
          //chartData['Active users'][] = _.keys(activeUsers).length;
          console.log(activeUsers);
          
          chart.series[0].addPoint([moment().format('HH:mm:ss'), _.keys(activeUsers).length]);
          
        });
      }

      MP.api.ready(function() {
        setInterval(getActiveUsers, 5000);
      });
    </script>
  </body>
</html>
